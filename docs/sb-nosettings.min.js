const VERSION="1.1.1";let video,videoID,skipSegments,muteSegments,muteEndTime,videoLabel;const getVideoID=()=>new URL(window.location.href).searchParams.get("v");function getJSON(e,t){const n=new XMLHttpRequest;n.open("GET",e),n.responseType="json",n.onload=()=>200==n.status?t(null,n.response):t(n.status),n.send()}function trackSkip(e){if(skipTracking){e=serverEndpoint+"/api/viewedVideoSponsorTime?UUID="+e;const t=new XMLHttpRequest;t.open("POST",e),t.send()}}function fetch(e){if(!video)return console.log("[SB.js] no video");getJSON(`${serverEndpoint}/api/skipSegments?videoID=${e}&categories=${JSON.stringify(categories)}&actionTypes=`+JSON.stringify(actionTypes),(e,t)=>{if(e)return console.error("[SB.js]","error fetching segments",e);skipSegments=new Map(t.filter(e=>"skip"===e.actionType).map(e=>[e.segment[0],{end:e.segment[1],uuid:e.UUID}])),muteSegments=new Map(t.filter(e=>"mute"===e.actionType).map(e=>[e.segment[0],{end:e.segment[1],uuid:e.UUID}])),createVideoLabel(videoLabel=t.filter(e=>"full"===e.actionType))}),console.log("[SB.js] Loaded Segments")}function skipOrMute(){var e=video.currentTime,t=(video.muted&&e>=muteEndTime&&(video.muted=!1,muteEndTime=0),findEndTime(e,skipSegments)),t=(t&&(video.currentTime=t),findEndTime(e,muteSegments));t&&(video.muted=!0,muteEndTime=t)}function findEndTime(e,t){let n=null;for(const s of t.keys())if(e+skipThreshold[0]>=s&&e-s<=skipThreshold[1]){var i,o=t.get(s);n=o.end,trackSkip(o.uuid),t.delete(s);for(const d of t.keys())n>=d&&d>=e&&(i=t.get(d),n=i.end,trackSkip(i.uuid),t.delete(d));return n}return n}function createVideoLabel(e){if(e.length){const n=document.querySelector("#title h1, h1.title.ytd-video-primary-info-renderer");if(n){var t=e[0].category;const i=document.createElement("span");i.innerText=t,i.id="sbjs-videolabel",i.style=`color: ${{selfpromo:"#111",sponsor:"#fff",exclusive_access:"#fff"}[t]}; background-color: ${{sponsor:"#0d0",selfpromo:"#ff0",exclusive_access:"#085"}[t]}; display: flex; margin: 0 5px;`,n.style="display: flex;",n.prepend(i)}else setTimeout(createVideoLabel,200,e)}}const reset=()=>{video=void 0,videoID=void 0,muteEndTime=0,videoLabel=void 0,skipSegments=[],muteSegments=[]};function setup(){videoID!==getVideoID()&&(console.log(`@mchangrh/SB.js ${VERSION} Loaded`),document.querySelector("#previewbar")&&(console.log("[SB.js] Extension Present, Exiting"),exit()),video=document.querySelector("video"),fetch(videoID=getVideoID()),video.addEventListener("timeupdate",skipOrMute))}document.addEventListener("yt-navigate-start",reset),document.addEventListener("yt-navigate-finish",setup),setup();